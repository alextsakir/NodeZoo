<div id="tickets-container">
<!--    <form class="booking-form capture-add-to-cart" id="ticket-selection-form" action="/api/tickets-selected" method="POST">-->
    <form class="booking-form capture-add-to-cart" id="ticket-selection-form">
        <h1>Buy your tickets here</h1>
        <ul id="choose-tickets" class="ticket-list">
            {{#each tickets}}
            <li class="ticket" id="{{name_EN}}" style="clear: both;">
                <div class="text">
                    <strong class="ticket-title"> {{ name_EN }} / {{ name_GR }} </strong>
                    <div class="price"> <span class="price-active"> â‚¬ {{ price }} </span> </div>
                </div>
                <div class="quantity">
                    <span class="ticket-selector">
                        <button type="button" aria-label="decrease quantity" class="minus-ticket-selector" data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Click and hold to remove faster..." title="">
                        <i class="fa fa-minus" aria-hidden="true"></i>
                        </button>
                        <span class="selector-total">
                            <input type="text" inputmode="numeric" pattern="^\d+$" value="0" id="{{name_EN}}" class="ticket-quantity-input" data-min="0" data-max="30">
                        </span>
                        <button type="button" aria-label="increase quantity" class="plus-ticket-selector" data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Click and hold to add faster..." title="">
                            <i class="ticket-selector-icon ticket-selector-icon--plus fa fa-plus" aria-hidden="true"></i>
                        </button>
                    </span>
                </div>
                <small class="max-indicator">40 max</small>
            </li>
        {{/each}}
        </ul>
        <div id="cat-total">
            <div class="button-div" id="ticket-list-actions">
                <button id="clear-ticket-selection" type="button">Clear selection <i class="fa fa-times" aria-hidden="true"></i></button>
                <button id="submit-tickets-button" type="button" class="fill me" data-analytics-event="click">Select your session<i class="fa fa-chevron-right"></i> </button>
            </div>
        </div>
    </form>
</div>

<dialog id="ticket-confirmation-dialog">
    <h1 id="ticket-confirmation-header">Are you sure for your choices?</h1>
    <p id="ticket-confirmation-paragraph"></p>
    <span id="ticket-confirmation-buttons">
        <button id="ticket-dialog-ok">OK</button>
        <button id="ticket-dialog-back">BACK</button>
    </span>
</dialog>

<script>
    let selectedData = {};

    let tickets = document.getElementsByTagName("li");
    // console.log(Array.from(tickets));
    Array.from(tickets).forEach(function (element) {
        let ticketId = element.id;
        let minusButton = document.querySelector(`#${ticketId} .minus-ticket-selector`);
        minusButton.addEventListener("click", function () {
            let quantityInput = document.querySelector(`#${ticketId} .ticket-quantity-input`);
            if (quantityInput.value > 0) quantityInput.value--;
        });
        let plusButton = document.querySelector(`#${ticketId} .plus-ticket-selector`);
        plusButton.addEventListener("click", function () {
            let quantityInput = document.querySelector(`#${ticketId} .ticket-quantity-input`);
            if (quantityInput.value < 40) quantityInput.value++;
        });
    });

    function clearQuantities () {
        let quantityInputs = document.querySelectorAll(".ticket-quantity-input");
        console.log(quantityInputs);
        for (let input of quantityInputs) input.value = 0;
        document.querySelector("#ticket-confirmation-dialog").querySelector("p").innerHTML = "";
        selectedData = {};
    }

    document.querySelector("#clear-ticket-selection").addEventListener("click", clearQuantities);

    let submitButton = document.querySelector("#submit-tickets-button");
    submitButton.addEventListener("click", function () {
        let ticketDivisions = document.querySelectorAll(".ticket");
        for (let ticket of ticketDivisions) {
            ticket.getElementsByTagName("span");
            let quantity = ticket.querySelector(".ticket-quantity-input");
            if (quantity.value > 0) selectedData[ticket.id] = quantity.value;
        }
        let confirmationDialog = document.querySelector("#ticket-confirmation-dialog");
        confirmationDialog.showModal();
        console.log(selectedData);
        let paragraph = confirmationDialog.querySelector("p");

        for (const [key, value] of Object.entries(selectedData)) {
            paragraph.innerHTML += `${key} ${value}<br>`;
        }
        // paragraph.innerHTML = selectedData.toString(); // ----------- todo
    });

    let confirmationBACK = document.querySelector("#ticket-dialog-back");
    confirmationBACK.addEventListener("click", function () {
        selectedData = {};
        document.querySelector("#ticket-confirmation-dialog").close();
    });

    let confirmationOK = document.querySelector("#ticket-dialog-ok");
    confirmationOK.addEventListener("click", function () {
        console.log("sending data...");
        // let xhr = new XMLHttpRequest();
        // xhr.open("POST", "/api/tickets-selected", true);
        // xhr.setRequestHeader("Content-Type", "application/json");
        // xhr.onreadystatechange = function () {
        //     if (xhr.status === 200) console.log(this.responseText);
        // };
        // xhr.send(JSON.stringify(selectedData));
        fetch("/api/tickets-selected", {
            method: "POST", body: JSON.stringify(selectedData)
        }).then(response => response.text())
    });


</script>
